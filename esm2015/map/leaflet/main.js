import * as L from 'leaflet';
import 'leaflet.markercluster';
import '@sersol/leaflet-plugins/leaflet-fullscreen';
import '@sersol/leaflet-plugins/leaflet-mouseposition';
import { mergeObjs } from '../../utils/object';
import { hasValue } from '../../utils/check';
import { LEAFLET_MAP_LAYERS } from './providers';
export class LeafletMap {
    constructor(options) {
        this.markers = {};
        this.options = {
            container: 'leaflet-map',
            initialView: {
                lat: 4.6288702,
                lng: -74.1193724,
                zoom: 11
            },
            clusterMarkers: {
                enable: true,
                config: {}
            },
            layers: LEAFLET_MAP_LAYERS,
            mapOptions: {
                positionControl: true,
                layers: [LEAFLET_MAP_LAYERS['Mapbox Street']],
                zoomControl: false
            },
            layersOptions: {
                position: 'topright'
            }
        };
        mergeObjs(this.options, options);
        this.map = new L.Map(this.options.container, this.options.mapOptions);
        this.layerControl = new L.Control.Layers(this.options.layers, null, this.options.layersOptions);
        this.map.addControl(new L.Control.MousePosition(this.options.mousePositionOptions));
        this.map.addControl(this.layerControl);
        this.map.addControl(new L.Control.Fullscreen(this.options.fullscreen));
        this.map.addControl(new L.Control.Zoom(this.options.zoom));
        this.map.setView([this.options.initialView.lat, this.options.initialView.lng], this.options.initialView.zoom);
        // Create cluster and scope
        if (this.options.clusterMarkers.enable) {
            this.initMarkerCluster();
        }
    }
    initMarkerCluster() {
        if (L.MarkerClusterGroup) {
            this.markerCluster = new L.MarkerClusterGroup([], this.options.clusterMarkers.config);
            this.map.addLayer(this.markerCluster);
        }
    }
    fitMarkersBounds(padding, flyTo) {
        if (hasValue(this.markers)) {
            const groupWrapper = [];
            // tslint:disable-next-line: forin
            for (const key in this.markers) {
                groupWrapper.push(this.markers[key]);
            }
            if (hasValue(groupWrapper)) {
                const pad = {
                    paddingTopLeft: {
                        x: 0,
                        y: 0
                    },
                    paddingBottomRight: {
                        x: 0,
                        y: 0
                    }
                };
                mergeObjs(pad, padding);
                const group = L.featureGroup(groupWrapper);
                if (flyTo) {
                    this.map.flyToBounds(group.getBounds(), {
                        duration: 0.5,
                        paddingTopLeft: [pad.paddingTopLeft.x, pad.paddingTopLeft.y],
                        paddingBottomRight: [pad.paddingBottomRight.x, pad.paddingBottomRight.y]
                    });
                }
                else {
                    this.map.fitBounds(group.getBounds(), {
                        paddingTopLeft: [pad.paddingTopLeft.x, pad.paddingTopLeft.y],
                        paddingBottomRight: [pad.paddingBottomRight.x, pad.paddingBottomRight.y]
                    });
                }
            }
        }
    }
    addMarker(latLng, id) {
        this.markers[id] = L.marker([latLng.lat, latLng.lng]);
        if (this.options.clusterMarkers.enable) {
            this.markerCluster.addLayer(this.markers[id]);
        }
        else {
            this.markers[id].addTo(this.map);
        }
        return this.markers[id];
    }
    panTo(latlng, offset, options) {
        if (hasValue(offset)) {
            const x = this.map.latLngToContainerPoint(latlng).x - offset[0];
            const y = this.map.latLngToContainerPoint(latlng).y - offset[1];
            const point = this.map.containerPointToLatLng([x, y]);
            return this.map.setView(point, this.map.getZoom(), options);
        }
        else {
            return this.map.setView(latlng, this.map.getZoom(), options);
        }
    }
    setView(latlng, targetZoom, offset, options) {
        if (hasValue(offset)) {
            const targetPoint = this.map.project(latlng, targetZoom).subtract(offset);
            const targetLatLng = this.map.unproject(targetPoint, targetZoom);
            return this.map.setView(targetLatLng, targetZoom, options);
        }
        else {
            return this.map.setView(latlng, targetZoom, options);
        }
    }
    centerPoint(options) {
        this.map.flyTo([options.lat, options.lng], options.preserve_zoom ? this.map.getZoom() : 19, {
            duration: 0.5
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzZXJzb2wvbmd4LyIsInNvdXJjZXMiOlsibWFwL2xlYWZsZXQvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssQ0FBQyxNQUFNLFNBQVMsQ0FBQztBQUM3QixPQUFPLHVCQUF1QixDQUFDO0FBQy9CLE9BQU8sNENBQTRDLENBQUM7QUFDcEQsT0FBTywrQ0FBK0MsQ0FBQztBQUN2RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRzdDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUVqRCxNQUFNLE9BQU8sVUFBVTtJQTJCbkIsWUFBWSxPQUEwQjtRQXpCdEMsWUFBTyxHQUFRLEVBQUUsQ0FBQztRQUdsQixZQUFPLEdBQXNCO1lBQ3pCLFNBQVMsRUFBRSxhQUFhO1lBQ3hCLFdBQVcsRUFBRTtnQkFDVCxHQUFHLEVBQUUsU0FBUztnQkFDZCxHQUFHLEVBQUUsQ0FBQyxVQUFVO2dCQUNoQixJQUFJLEVBQUUsRUFBRTthQUNYO1lBQ0QsY0FBYyxFQUFFO2dCQUNaLE1BQU0sRUFBRSxJQUFJO2dCQUNaLE1BQU0sRUFBRSxFQUFFO2FBQ2I7WUFDRCxNQUFNLEVBQUUsa0JBQWtCO1lBQzFCLFVBQVUsRUFBRTtnQkFDUixlQUFlLEVBQUUsSUFBSTtnQkFDckIsTUFBTSxFQUFFLENBQUMsa0JBQWtCLENBQUMsZUFBZSxDQUFDLENBQUM7Z0JBQzdDLFdBQVcsRUFBRSxLQUFLO2FBQ3JCO1lBQ0QsYUFBYSxFQUFFO2dCQUNYLFFBQVEsRUFBRSxVQUFVO2FBQ3ZCO1NBQ0osQ0FBQztRQUlFLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRWpDLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLElB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TTtZQUNILE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUN4RDtJQUVMLENBQUM7SUFFRCxXQUFXLENBQUMsT0FBb0I7UUFDNUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDeEYsUUFBUSxFQUFFLEdBQUc7U0FDaEIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgTCBmcm9tICdsZWFmbGV0JztcclxuaW1wb3J0ICdsZWFmbGV0Lm1hcmtlcmNsdXN0ZXInO1xyXG5pbXBvcnQgJ0BzZXJzb2wvbGVhZmxldC1wbHVnaW5zL2xlYWZsZXQtZnVsbHNjcmVlbic7XHJcbmltcG9ydCAnQHNlcnNvbC9sZWFmbGV0LXBsdWdpbnMvbGVhZmxldC1tb3VzZXBvc2l0aW9uJztcclxuaW1wb3J0IHsgbWVyZ2VPYmpzIH0gZnJvbSAnLi4vLi4vdXRpbHMvb2JqZWN0JztcclxuaW1wb3J0IHsgaGFzVmFsdWUgfSBmcm9tICcuLi8uLi91dGlscy9jaGVjayc7XHJcbmltcG9ydCB7IExlYWZsZXRNYXBPcHRpb25zLCBMZWFmbGV0UGFkZGluZyB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBDZW50ZXJQb2ludCwgTGF0TG5nIH0gZnJvbSAnLi4vdHlwZXMnO1xyXG5pbXBvcnQgeyBMRUFGTEVUX01BUF9MQVlFUlMgfSBmcm9tICcuL3Byb3ZpZGVycyc7XHJcblxyXG5leHBvcnQgY2xhc3MgTGVhZmxldE1hcCB7XHJcbiAgICBtYXA6IEwuTWFwO1xyXG4gICAgbWFya2VyczogYW55ID0ge307XHJcbiAgICBtYXJrZXJDbHVzdGVyOiBMLk1hcmtlckNsdXN0ZXJHcm91cDtcclxuICAgIGxheWVyQ29udHJvbDogTC5Db250cm9sLkxheWVycztcclxuICAgIG9wdGlvbnM6IExlYWZsZXRNYXBPcHRpb25zID0ge1xyXG4gICAgICAgIGNvbnRhaW5lcjogJ2xlYWZsZXQtbWFwJyxcclxuICAgICAgICBpbml0aWFsVmlldzoge1xyXG4gICAgICAgICAgICBsYXQ6IDQuNjI4ODcwMixcclxuICAgICAgICAgICAgbG5nOiAtNzQuMTE5MzcyNCxcclxuICAgICAgICAgICAgem9vbTogMTFcclxuICAgICAgICB9LFxyXG4gICAgICAgIGNsdXN0ZXJNYXJrZXJzOiB7XHJcbiAgICAgICAgICAgIGVuYWJsZTogdHJ1ZSxcclxuICAgICAgICAgICAgY29uZmlnOiB7fVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbGF5ZXJzOiBMRUFGTEVUX01BUF9MQVlFUlMsXHJcbiAgICAgICAgbWFwT3B0aW9uczoge1xyXG4gICAgICAgICAgICBwb3NpdGlvbkNvbnRyb2w6IHRydWUsXHJcbiAgICAgICAgICAgIGxheWVyczogW0xFQUZMRVRfTUFQX0xBWUVSU1snTWFwYm94IFN0cmVldCddXSxcclxuICAgICAgICAgICAgem9vbUNvbnRyb2w6IGZhbHNlXHJcbiAgICAgICAgfSxcclxuICAgICAgICBsYXllcnNPcHRpb25zOiB7XHJcbiAgICAgICAgICAgIHBvc2l0aW9uOiAndG9wcmlnaHQnXHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBMZWFmbGV0TWFwT3B0aW9ucykge1xyXG5cclxuICAgICAgICBtZXJnZU9ianModGhpcy5vcHRpb25zLCBvcHRpb25zKTtcclxuXHJcbiAgICAgICAgdGhpcy5tYXAgPSBuZXcgTC5NYXAodGhpcy5vcHRpb25zLmNvbnRhaW5lciwgdGhpcy5vcHRpb25zLm1hcE9wdGlvbnMpO1xyXG5cclxuICAgICAgICB0aGlzLmxheWVyQ29udHJvbCA9IG5ldyBMLkNvbnRyb2wuTGF5ZXJzKHRoaXMub3B0aW9ucy5sYXllcnMsIG51bGwsIHRoaXMub3B0aW9ucy5sYXllcnNPcHRpb25zKTtcclxuICAgICAgICB0aGlzLm1hcC5hZGRDb250cm9sKG5ldyBMLkNvbnRyb2wuTW91c2VQb3NpdGlvbih0aGlzLm9wdGlvbnMubW91c2VQb3NpdGlvbk9wdGlvbnMpKTtcclxuICAgICAgICB0aGlzLm1hcC5hZGRDb250cm9sKHRoaXMubGF5ZXJDb250cm9sKTtcclxuICAgICAgICB0aGlzLm1hcC5hZGRDb250cm9sKG5ldyBMLkNvbnRyb2wuRnVsbHNjcmVlbih0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbikpO1xyXG4gICAgICAgIHRoaXMubWFwLmFkZENvbnRyb2wobmV3IEwuQ29udHJvbC5ab29tKHRoaXMub3B0aW9ucy56b29tKSk7XHJcblxyXG4gICAgICAgIHRoaXMubWFwLnNldFZpZXcoW3RoaXMub3B0aW9ucy5pbml0aWFsVmlldy5sYXQsIHRoaXMub3B0aW9ucy5pbml0aWFsVmlldy5sbmddLCB0aGlzLm9wdGlvbnMuaW5pdGlhbFZpZXcuem9vbSk7XHJcblxyXG4gICAgICAgIC8vIENyZWF0ZSBjbHVzdGVyIGFuZCBzY29wZVxyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuY2x1c3Rlck1hcmtlcnMuZW5hYmxlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdE1hcmtlckNsdXN0ZXIoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGluaXRNYXJrZXJDbHVzdGVyKCkge1xyXG4gICAgICAgIGlmIChMLk1hcmtlckNsdXN0ZXJHcm91cCkge1xyXG4gICAgICAgICAgICB0aGlzLm1hcmtlckNsdXN0ZXIgPSBuZXcgTC5NYXJrZXJDbHVzdGVyR3JvdXAoW10sIHRoaXMub3B0aW9ucy5jbHVzdGVyTWFya2Vycy5jb25maWcpO1xyXG4gICAgICAgICAgICB0aGlzLm1hcC5hZGRMYXllcih0aGlzLm1hcmtlckNsdXN0ZXIpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmaXRNYXJrZXJzQm91bmRzKHBhZGRpbmc/OiBMZWFmbGV0UGFkZGluZywgZmx5VG8/OiBib29sZWFuKSB7XHJcblxyXG4gICAgICAgIGlmIChoYXNWYWx1ZSh0aGlzLm1hcmtlcnMpKSB7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBncm91cFdyYXBwZXIgPSBbXTtcclxuXHJcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogZm9yaW5cclxuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5tYXJrZXJzKSB7XHJcbiAgICAgICAgICAgICAgICBncm91cFdyYXBwZXIucHVzaCh0aGlzLm1hcmtlcnNba2V5XSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChoYXNWYWx1ZShncm91cFdyYXBwZXIpKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgcGFkOiBMZWFmbGV0UGFkZGluZyA9IHtcclxuICAgICAgICAgICAgICAgICAgICBwYWRkaW5nVG9wTGVmdDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB4OiAwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB5OiAwXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBwYWRkaW5nQm90dG9tUmlnaHQ6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgeDogMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgeTogMFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgbWVyZ2VPYmpzKHBhZCwgcGFkZGluZyk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgZ3JvdXAgPSBMLmZlYXR1cmVHcm91cChncm91cFdyYXBwZXIpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChmbHlUbykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWFwLmZseVRvQm91bmRzKGdyb3VwLmdldEJvdW5kcygpLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAwLjUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmdUb3BMZWZ0OiBbcGFkLnBhZGRpbmdUb3BMZWZ0LngsIHBhZC5wYWRkaW5nVG9wTGVmdC55XSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZ0JvdHRvbVJpZ2h0OiBbcGFkLnBhZGRpbmdCb3R0b21SaWdodC54LCBwYWQucGFkZGluZ0JvdHRvbVJpZ2h0LnldXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWFwLmZpdEJvdW5kcyhncm91cC5nZXRCb3VuZHMoKSwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nVG9wTGVmdDogW3BhZC5wYWRkaW5nVG9wTGVmdC54LCBwYWQucGFkZGluZ1RvcExlZnQueV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmdCb3R0b21SaWdodDogW3BhZC5wYWRkaW5nQm90dG9tUmlnaHQueCwgcGFkLnBhZGRpbmdCb3R0b21SaWdodC55XVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgYWRkTWFya2VyKGxhdExuZzogTGF0TG5nLCBpZDogYW55KSB7XHJcblxyXG4gICAgICAgIHRoaXMubWFya2Vyc1tpZF0gPSBMLm1hcmtlcihbbGF0TG5nLmxhdCwgbGF0TG5nLmxuZ10pO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmNsdXN0ZXJNYXJrZXJzLmVuYWJsZSkge1xyXG4gICAgICAgICAgICB0aGlzLm1hcmtlckNsdXN0ZXIuYWRkTGF5ZXIodGhpcy5tYXJrZXJzW2lkXSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5tYXJrZXJzW2lkXS5hZGRUbyh0aGlzLm1hcCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5tYXJrZXJzW2lkXTtcclxuICAgIH1cclxuXHJcbiAgICBwYW5UbyhsYXRsbmc6IEwuTGF0TG5nLCBvZmZzZXQ/OiBMLlBvaW50RXhwcmVzc2lvbiwgb3B0aW9ucz86IEwuWm9vbVBhbk9wdGlvbnMpIHtcclxuXHJcbiAgICAgICAgaWYgKGhhc1ZhbHVlKG9mZnNldCkpIHtcclxuICAgICAgICAgICAgY29uc3QgeCA9IHRoaXMubWFwLmxhdExuZ1RvQ29udGFpbmVyUG9pbnQobGF0bG5nKS54IC0gb2Zmc2V0WzBdO1xyXG4gICAgICAgICAgICBjb25zdCB5ID0gdGhpcy5tYXAubGF0TG5nVG9Db250YWluZXJQb2ludChsYXRsbmcpLnkgLSBvZmZzZXRbMV07XHJcbiAgICAgICAgICAgIGNvbnN0IHBvaW50ID0gdGhpcy5tYXAuY29udGFpbmVyUG9pbnRUb0xhdExuZyhbeCwgeV0pO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5tYXAuc2V0Vmlldyhwb2ludCwgdGhpcy5tYXAuZ2V0Wm9vbSgpLCBvcHRpb25zKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5tYXAuc2V0VmlldyhsYXRsbmcsIHRoaXMubWFwLmdldFpvb20oKSwgb3B0aW9ucyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNldFZpZXcobGF0bG5nOiBMLkxhdExuZywgdGFyZ2V0Wm9vbTogbnVtYmVyLCBvZmZzZXQ/OiBMLlBvaW50RXhwcmVzc2lvbiwgb3B0aW9ucz86IEwuWm9vbVBhbk9wdGlvbnMpIHtcclxuXHJcbiAgICAgICAgaWYgKGhhc1ZhbHVlKG9mZnNldCkpIHtcclxuICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9pbnQgPSB0aGlzLm1hcC5wcm9qZWN0KGxhdGxuZywgdGFyZ2V0Wm9vbSkuc3VidHJhY3Qob2Zmc2V0KTtcclxuICAgICAgICAgICAgY29uc3QgdGFyZ2V0TGF0TG5nID0gdGhpcy5tYXAudW5wcm9qZWN0KHRhcmdldFBvaW50LCB0YXJnZXRab29tKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFwLnNldFZpZXcodGFyZ2V0TGF0TG5nLCB0YXJnZXRab29tLCBvcHRpb25zKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5tYXAuc2V0VmlldyhsYXRsbmcsIHRhcmdldFpvb20sIG9wdGlvbnMpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgY2VudGVyUG9pbnQob3B0aW9uczogQ2VudGVyUG9pbnQpIHtcclxuICAgICAgICB0aGlzLm1hcC5mbHlUbyhbb3B0aW9ucy5sYXQsIG9wdGlvbnMubG5nXSwgb3B0aW9ucy5wcmVzZXJ2ZV96b29tID8gdGhpcy5tYXAuZ2V0Wm9vbSgpIDogMTksIHtcclxuICAgICAgICAgICAgZHVyYXRpb246IDAuNVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=