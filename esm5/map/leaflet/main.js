import * as L from 'leaflet';
import 'leaflet.markercluster';
import '@sersol/leaflet-plugins/leaflet-fullscreen';
import '@sersol/leaflet-plugins/leaflet-mouseposition';
import { mergeObjs } from '../../utils/object';
import { hasValue } from '../../utils/check';
import { LEAFLET_MAP_LAYERS } from './providers';
var LeafletMap = /** @class */ (function () {
    function LeafletMap(options) {
        this.markers = {};
        this.options = {
            container: 'leaflet-map',
            initialView: {
                lat: 4.6288702,
                lng: -74.1193724,
                zoom: 11
            },
            clusterMarkers: {
                enable: true,
                config: {}
            },
            layers: LEAFLET_MAP_LAYERS,
            mapOptions: {
                positionControl: true,
                layers: [LEAFLET_MAP_LAYERS['Mapbox Street']],
                zoomControl: false
            },
            layersOptions: {
                position: 'topright'
            }
        };
        mergeObjs(this.options, options);
        this.map = new L.Map(this.options.container, this.options.mapOptions);
        this.layerControl = new L.Control.Layers(this.options.layers, null, this.options.layersOptions);
        this.map.addControl(new L.Control.MousePosition(this.options.mousePositionOptions));
        this.map.addControl(this.layerControl);
        this.map.addControl(new L.Control.Fullscreen(this.options.fullscreen));
        this.map.addControl(new L.Control.Zoom(this.options.zoom));
        this.map.setView([this.options.initialView.lat, this.options.initialView.lng], this.options.initialView.zoom);
        // Create cluster and scope
        if (this.options.clusterMarkers.enable) {
            this.initMarkerCluster();
        }
    }
    LeafletMap.prototype.initMarkerCluster = function () {
        if (L.MarkerClusterGroup) {
            this.markerCluster = new L.MarkerClusterGroup([], this.options.clusterMarkers.config);
            this.map.addLayer(this.markerCluster);
        }
    };
    LeafletMap.prototype.fitMarkersBounds = function (padding, flyTo) {
        if (hasValue(this.markers)) {
            var groupWrapper = [];
            // tslint:disable-next-line: forin
            for (var key in this.markers) {
                groupWrapper.push(this.markers[key]);
            }
            if (hasValue(groupWrapper)) {
                var pad = {
                    paddingTopLeft: {
                        x: 0,
                        y: 0
                    },
                    paddingBottomRight: {
                        x: 0,
                        y: 0
                    }
                };
                mergeObjs(pad, padding);
                var group = L.featureGroup(groupWrapper);
                if (flyTo) {
                    this.map.flyToBounds(group.getBounds(), {
                        duration: 0.5,
                        paddingTopLeft: [pad.paddingTopLeft.x, pad.paddingTopLeft.y],
                        paddingBottomRight: [pad.paddingBottomRight.x, pad.paddingBottomRight.y]
                    });
                }
                else {
                    this.map.fitBounds(group.getBounds(), {
                        paddingTopLeft: [pad.paddingTopLeft.x, pad.paddingTopLeft.y],
                        paddingBottomRight: [pad.paddingBottomRight.x, pad.paddingBottomRight.y]
                    });
                }
            }
        }
    };
    LeafletMap.prototype.addMarker = function (latLng, id) {
        this.markers[id] = L.marker([latLng.lat, latLng.lng]);
        if (this.options.clusterMarkers.enable) {
            this.markerCluster.addLayer(this.markers[id]);
        }
        else {
            this.markers[id].addTo(this.map);
        }
        return this.markers[id];
    };
    LeafletMap.prototype.panTo = function (latlng, offset, options) {
        if (hasValue(offset)) {
            var x = this.map.latLngToContainerPoint(latlng).x - offset[0];
            var y = this.map.latLngToContainerPoint(latlng).y - offset[1];
            var point = this.map.containerPointToLatLng([x, y]);
            return this.map.setView(point, this.map.getZoom(), options);
        }
        else {
            return this.map.setView(latlng, this.map.getZoom(), options);
        }
    };
    LeafletMap.prototype.setView = function (latlng, targetZoom, offset, options) {
        if (hasValue(offset)) {
            var targetPoint = this.map.project(latlng, targetZoom).subtract(offset);
            var targetLatLng = this.map.unproject(targetPoint, targetZoom);
            return this.map.setView(targetLatLng, targetZoom, options);
        }
        else {
            return this.map.setView(latlng, targetZoom, options);
        }
    };
    LeafletMap.prototype.centerPoint = function (options) {
        this.map.flyTo([options.lat, options.lng], options.preserve_zoom ? this.map.getZoom() : 19, {
            duration: 0.5
        });
    };
    return LeafletMap;
}());
export { LeafletMap };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzZXJzb2wvbmd4LyIsInNvdXJjZXMiOlsibWFwL2xlYWZsZXQvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssQ0FBQyxNQUFNLFNBQVMsQ0FBQztBQUM3QixPQUFPLHVCQUF1QixDQUFDO0FBQy9CLE9BQU8sNENBQTRDLENBQUM7QUFDcEQsT0FBTywrQ0FBK0MsQ0FBQztBQUN2RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRzdDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUVqRDtJQTJCSSxvQkFBWSxPQUEwQjtRQXpCdEMsWUFBTyxHQUFRLEVBQUUsQ0FBQztRQUdsQixZQUFPLEdBQXNCO1lBQ3pCLFNBQVMsRUFBRSxhQUFhO1lBQ3hCLFdBQVcsRUFBRTtnQkFDVCxHQUFHLEVBQUUsU0FBUztnQkFDZCxHQUFHLEVBQUUsQ0FBQyxVQUFVO2dCQUNoQixJQUFJLEVBQUUsRUFBRTthQUNYO1lBQ0QsY0FBYyxFQUFFO2dCQUNaLE1BQU0sRUFBRSxJQUFJO2dCQUNaLE1BQU0sRUFBRSxFQUFFO2FBQ2I7WUFDRCxNQUFNLEVBQUUsa0JBQWtCO1lBQzFCLFVBQVUsRUFBRTtnQkFDUixlQUFlLEVBQUUsSUFBSTtnQkFDckIsTUFBTSxFQUFFLENBQUMsa0JBQWtCLENBQUMsZUFBZSxDQUFDLENBQUM7Z0JBQzdDLFdBQVcsRUFBRSxLQUFLO2FBQ3JCO1lBQ0QsYUFBYSxFQUFFO2dCQUNYLFFBQVEsRUFBRSxVQUFVO2FBQ3ZCO1NBQ0osQ0FBQztRQUlFLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRWpDLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENB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QyxDQUFDO1NBQzlEO2FBQU07WUFDSCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDeEQ7SUFFTCxDQUFDO0lBRUQsZ0NBQVcsR0FBWCxVQUFZLE9BQW9CO1FBQzVCLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO1lBQ3hGLFFBQVEsRUFBRSxHQUFHO1NBQ2hCLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTCxpQkFBQztBQUFELENBQUMsQUFoSkQsSUFnSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBMIGZyb20gJ2xlYWZsZXQnO1xyXG5pbXBvcnQgJ2xlYWZsZXQubWFya2VyY2x1c3Rlcic7XHJcbmltcG9ydCAnQHNlcnNvbC9sZWFmbGV0LXBsdWdpbnMvbGVhZmxldC1mdWxsc2NyZWVuJztcclxuaW1wb3J0ICdAc2Vyc29sL2xlYWZsZXQtcGx1Z2lucy9sZWFmbGV0LW1vdXNlcG9zaXRpb24nO1xyXG5pbXBvcnQgeyBtZXJnZU9ianMgfSBmcm9tICcuLi8uLi91dGlscy9vYmplY3QnO1xyXG5pbXBvcnQgeyBoYXNWYWx1ZSB9IGZyb20gJy4uLy4uL3V0aWxzL2NoZWNrJztcclxuaW1wb3J0IHsgTGVhZmxldE1hcE9wdGlvbnMsIExlYWZsZXRQYWRkaW5nIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IENlbnRlclBvaW50LCBMYXRMbmcgfSBmcm9tICcuLi90eXBlcyc7XHJcbmltcG9ydCB7IExFQUZMRVRfTUFQX0xBWUVSUyB9IGZyb20gJy4vcHJvdmlkZXJzJztcclxuXHJcbmV4cG9ydCBjbGFzcyBMZWFmbGV0TWFwIHtcclxuICAgIG1hcDogTC5NYXA7XHJcbiAgICBtYXJrZXJzOiBhbnkgPSB7fTtcclxuICAgIG1hcmtlckNsdXN0ZXI6IEwuTWFya2VyQ2x1c3Rlckdyb3VwO1xyXG4gICAgbGF5ZXJDb250cm9sOiBMLkNvbnRyb2wuTGF5ZXJzO1xyXG4gICAgb3B0aW9uczogTGVhZmxldE1hcE9wdGlvbnMgPSB7XHJcbiAgICAgICAgY29udGFpbmVyOiAnbGVhZmxldC1tYXAnLFxyXG4gICAgICAgIGluaXRpYWxWaWV3OiB7XHJcbiAgICAgICAgICAgIGxhdDogNC42Mjg4NzAyLFxyXG4gICAgICAgICAgICBsbmc6IC03NC4xMTkzNzI0LFxyXG4gICAgICAgICAgICB6b29tOiAxMVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY2x1c3Rlck1hcmtlcnM6IHtcclxuICAgICAgICAgICAgZW5hYmxlOiB0cnVlLFxyXG4gICAgICAgICAgICBjb25maWc6IHt9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBsYXllcnM6IExFQUZMRVRfTUFQX0xBWUVSUyxcclxuICAgICAgICBtYXBPcHRpb25zOiB7XHJcbiAgICAgICAgICAgIHBvc2l0aW9uQ29udHJvbDogdHJ1ZSxcclxuICAgICAgICAgICAgbGF5ZXJzOiBbTEVBRkxFVF9NQVBfTEFZRVJTWydNYXBib3ggU3RyZWV0J11dLFxyXG4gICAgICAgICAgICB6b29tQ29udHJvbDogZmFsc2VcclxuICAgICAgICB9LFxyXG4gICAgICAgIGxheWVyc09wdGlvbnM6IHtcclxuICAgICAgICAgICAgcG9zaXRpb246ICd0b3ByaWdodCdcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IExlYWZsZXRNYXBPcHRpb25zKSB7XHJcblxyXG4gICAgICAgIG1lcmdlT2Jqcyh0aGlzLm9wdGlvbnMsIG9wdGlvbnMpO1xyXG5cclxuICAgICAgICB0aGlzLm1hcCA9IG5ldyBMLk1hcCh0aGlzLm9wdGlvbnMuY29udGFpbmVyLCB0aGlzLm9wdGlvbnMubWFwT3B0aW9ucyk7XHJcblxyXG4gICAgICAgIHRoaXMubGF5ZXJDb250cm9sID0gbmV3IEwuQ29udHJvbC5MYXllcnModGhpcy5vcHRpb25zLmxheWVycywgbnVsbCwgdGhpcy5vcHRpb25zLmxheWVyc09wdGlvbnMpO1xyXG4gICAgICAgIHRoaXMubWFwLmFkZENvbnRyb2wobmV3IEwuQ29udHJvbC5Nb3VzZVBvc2l0aW9uKHRoaXMub3B0aW9ucy5tb3VzZVBvc2l0aW9uT3B0aW9ucykpO1xyXG4gICAgICAgIHRoaXMubWFwLmFkZENvbnRyb2wodGhpcy5sYXllckNvbnRyb2wpO1xyXG4gICAgICAgIHRoaXMubWFwLmFkZENvbnRyb2wobmV3IEwuQ29udHJvbC5GdWxsc2NyZWVuKHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuKSk7XHJcbiAgICAgICAgdGhpcy5tYXAuYWRkQ29udHJvbChuZXcgTC5Db250cm9sLlpvb20odGhpcy5vcHRpb25zLnpvb20pKTtcclxuXHJcbiAgICAgICAgdGhpcy5tYXAuc2V0VmlldyhbdGhpcy5vcHRpb25zLmluaXRpYWxWaWV3LmxhdCwgdGhpcy5vcHRpb25zLmluaXRpYWxWaWV3LmxuZ10sIHRoaXMub3B0aW9ucy5pbml0aWFsVmlldy56b29tKTtcclxuXHJcbiAgICAgICAgLy8gQ3JlYXRlIGNsdXN0ZXIgYW5kIHNjb3BlXHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5jbHVzdGVyTWFya2Vycy5lbmFibGUpIHtcclxuICAgICAgICAgICAgdGhpcy5pbml0TWFya2VyQ2x1c3RlcigpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgaW5pdE1hcmtlckNsdXN0ZXIoKSB7XHJcbiAgICAgICAgaWYgKEwuTWFya2VyQ2x1c3Rlckdyb3VwKSB7XHJcbiAgICAgICAgICAgIHRoaXMubWFya2VyQ2x1c3RlciA9IG5ldyBMLk1hcmtlckNsdXN0ZXJHcm91cChbXSwgdGhpcy5vcHRpb25zLmNsdXN0ZXJNYXJrZXJzLmNvbmZpZyk7XHJcbiAgICAgICAgICAgIHRoaXMubWFwLmFkZExheWVyKHRoaXMubWFya2VyQ2x1c3Rlcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZpdE1hcmtlcnNCb3VuZHMocGFkZGluZz86IExlYWZsZXRQYWRkaW5nLCBmbHlUbz86IGJvb2xlYW4pIHtcclxuXHJcbiAgICAgICAgaWYgKGhhc1ZhbHVlKHRoaXMubWFya2VycykpIHtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGdyb3VwV3JhcHBlciA9IFtdO1xyXG5cclxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBmb3JpblxyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLm1hcmtlcnMpIHtcclxuICAgICAgICAgICAgICAgIGdyb3VwV3JhcHBlci5wdXNoKHRoaXMubWFya2Vyc1trZXldKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGhhc1ZhbHVlKGdyb3VwV3JhcHBlcikpIHtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYWQ6IExlYWZsZXRQYWRkaW5nID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhZGRpbmdUb3BMZWZ0OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHg6IDAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHk6IDBcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHBhZGRpbmdCb3R0b21SaWdodDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB4OiAwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB5OiAwXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICBtZXJnZU9ianMocGFkLCBwYWRkaW5nKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBncm91cCA9IEwuZmVhdHVyZUdyb3VwKGdyb3VwV3JhcHBlcik7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGZseVRvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXAuZmx5VG9Cb3VuZHMoZ3JvdXAuZ2V0Qm91bmRzKCksIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDAuNSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZ1RvcExlZnQ6IFtwYWQucGFkZGluZ1RvcExlZnQueCwgcGFkLnBhZGRpbmdUb3BMZWZ0LnldLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nQm90dG9tUmlnaHQ6IFtwYWQucGFkZGluZ0JvdHRvbVJpZ2h0LngsIHBhZC5wYWRkaW5nQm90dG9tUmlnaHQueV1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXAuZml0Qm91bmRzKGdyb3VwLmdldEJvdW5kcygpLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmdUb3BMZWZ0OiBbcGFkLnBhZGRpbmdUb3BMZWZ0LngsIHBhZC5wYWRkaW5nVG9wTGVmdC55XSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZ0JvdHRvbVJpZ2h0OiBbcGFkLnBhZGRpbmdCb3R0b21SaWdodC54LCBwYWQucGFkZGluZ0JvdHRvbVJpZ2h0LnldXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBhZGRNYXJrZXIobGF0TG5nOiBMYXRMbmcsIGlkOiBhbnkpIHtcclxuXHJcbiAgICAgICAgdGhpcy5tYXJrZXJzW2lkXSA9IEwubWFya2VyKFtsYXRMbmcubGF0LCBsYXRMbmcubG5nXSk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuY2x1c3Rlck1hcmtlcnMuZW5hYmxlKSB7XHJcbiAgICAgICAgICAgIHRoaXMubWFya2VyQ2x1c3Rlci5hZGRMYXllcih0aGlzLm1hcmtlcnNbaWRdKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLm1hcmtlcnNbaWRdLmFkZFRvKHRoaXMubWFwKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLm1hcmtlcnNbaWRdO1xyXG4gICAgfVxyXG5cclxuICAgIHBhblRvKGxhdGxuZzogTC5MYXRMbmcsIG9mZnNldD86IEwuUG9pbnRFeHByZXNzaW9uLCBvcHRpb25zPzogTC5ab29tUGFuT3B0aW9ucykge1xyXG5cclxuICAgICAgICBpZiAoaGFzVmFsdWUob2Zmc2V0KSkge1xyXG4gICAgICAgICAgICBjb25zdCB4ID0gdGhpcy5tYXAubGF0TG5nVG9Db250YWluZXJQb2ludChsYXRsbmcpLnggLSBvZmZzZXRbMF07XHJcbiAgICAgICAgICAgIGNvbnN0IHkgPSB0aGlzLm1hcC5sYXRMbmdUb0NvbnRhaW5lclBvaW50KGxhdGxuZykueSAtIG9mZnNldFsxXTtcclxuICAgICAgICAgICAgY29uc3QgcG9pbnQgPSB0aGlzLm1hcC5jb250YWluZXJQb2ludFRvTGF0TG5nKFt4LCB5XSk7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcC5zZXRWaWV3KHBvaW50LCB0aGlzLm1hcC5nZXRab29tKCksIG9wdGlvbnMpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcC5zZXRWaWV3KGxhdGxuZywgdGhpcy5tYXAuZ2V0Wm9vbSgpLCBvcHRpb25zKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2V0VmlldyhsYXRsbmc6IEwuTGF0TG5nLCB0YXJnZXRab29tOiBudW1iZXIsIG9mZnNldD86IEwuUG9pbnRFeHByZXNzaW9uLCBvcHRpb25zPzogTC5ab29tUGFuT3B0aW9ucykge1xyXG5cclxuICAgICAgICBpZiAoaGFzVmFsdWUob2Zmc2V0KSkge1xyXG4gICAgICAgICAgICBjb25zdCB0YXJnZXRQb2ludCA9IHRoaXMubWFwLnByb2plY3QobGF0bG5nLCB0YXJnZXRab29tKS5zdWJ0cmFjdChvZmZzZXQpO1xyXG4gICAgICAgICAgICBjb25zdCB0YXJnZXRMYXRMbmcgPSB0aGlzLm1hcC51bnByb2plY3QodGFyZ2V0UG9pbnQsIHRhcmdldFpvb20pO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5tYXAuc2V0Vmlldyh0YXJnZXRMYXRMbmcsIHRhcmdldFpvb20sIG9wdGlvbnMpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcC5zZXRWaWV3KGxhdGxuZywgdGFyZ2V0Wm9vbSwgb3B0aW9ucyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBjZW50ZXJQb2ludChvcHRpb25zOiBDZW50ZXJQb2ludCkge1xyXG4gICAgICAgIHRoaXMubWFwLmZseVRvKFtvcHRpb25zLmxhdCwgb3B0aW9ucy5sbmddLCBvcHRpb25zLnByZXNlcnZlX3pvb20gPyB0aGlzLm1hcC5nZXRab29tKCkgOiAxOSwge1xyXG4gICAgICAgICAgICBkdXJhdGlvbjogMC41XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==